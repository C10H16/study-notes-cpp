# C++内存管理

## 第四讲 loki::allocator

### loki allocator, 3 classes

![](./img/4-1.JPG)

#### Chunk

pData 指针，指向一整块空间

firstAvailableBlock：指向第一个可用区块，不是使用指针，而是一个索引，代表是第几号区块。

blocksAvailable_：目前还可以供应的区块

#### FixedAllocator

两个指针指向 chunks_ 中的某两个 Chunk

#### SmallObjAllocator

两个指针指向 pool_ 中的某两个 chunks_ 向量

### Chunk

```C++
void FixedAllocator::Chunk::Init(std::size_t blockSize, unsigned char blocks)
{
    pData_ = new unsigned char[blockSize * blocks];
    Reset(blockSize, blocks);
}
void FixedAllocator::Chunk::Reset(std::size_t blockSize, unsigned char blocks)
{
    first Available Block_ = 0;
    blocksAvailable_ = blocks;
    unsigned char i = 0;
    unsigned char* p = pData_;
    for(; i!=blocks; p += blockSize) // 流水号标示索引
        *p = ++i;
}

void FixedAllocator::Chunk::Release()
{
    delete[] pData_; // 释放自己
    // 此函数被上一层调用
}
```

```C++
void* FixedAllocator::Chunk::Allocate(std::size_t blockSize)
{
    if(!blocksAvailable_) return 0;
    
    unsigned char* pResult = 
        pData_ + (firstAvailableBlock_ * blockSize); // 指向第一个可用区块
    
    firstAvailableBlock_=*pResult; // 右侧索引便是下一个可用区块
    --blockAvailable_;
    
    return pResult;
}
```



![](./img/4-2.JPG)图中第4块为优先权最高的区块，当需要分配空间时，将第四块分配出去。然后将其内容存到 firstAvailableBlock_ 中，即变为 3 ，可用区块数目减一，由 64 变为 63。

使用数组代替链表，索引代替指针。

```C++
void FixedAllocator::Chunk::Deallocate(void* n, std::size_t blockSize)

{
    unsigned char* toRelease = static_cast<unsigned char*> (p);

    *toRelease = firstAvailableBlock_;
    firstAvailableBlock_=static_cast<unsigned char>(
        (toRelease - pData_)/blockSize);
    ++blockAvailable_; // 可用区块数加1
}
```

![](./img/4-3.JPG)

将firstAvailableBlock\_的值赋给归还的空间，指针 p 减掉头，再除以每一块的大小得到 p 指向的是第几块。将其赋值给 firstAvailableBlock\_，